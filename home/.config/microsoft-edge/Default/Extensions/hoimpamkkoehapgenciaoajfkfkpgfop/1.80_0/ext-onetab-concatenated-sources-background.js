// Copyright 2023 OneTab Ltd.  All rights reserved.
const ut="1.80",Ge=!1,Ie=!1,We=!1,Ae=!1,Ce=!1,Oe=!1,Ee=!0,wt="edge://",y="edge://newtab/",St="https://www.one-tab.com",Pe=!1,ke=!1,Fe=!1,c=chrome.runtime.getURL("onetab.html"),L=c.substring(0,c.length-"onetab.html".length);let ct=!0;async function Z(){return ct?(await chrome.permissions.getAll()).permissions.includes("tabGroups")&&chrome.tabGroups:!1}async function Gt(){if(!ct)return!1;try{return await chrome.permissions.request({permissions:["tabGroups"]})}catch(s){return console.log('chrome.permissions.request for "tabGroups" permission failed with error:'),console.log(s),!1}}function De(s){let t=$(s);return t.toLowerCase().startsWith("www.")?t.substring("www.".length):t}function $(s){return s?(s.indexOf("//")===0&&(s="http:"+s),s.indexOf("://")===-1&&(s="http://"+s),s=s.substring(s.indexOf("://")+"://".length),s.indexOf("/")!==-1&&(s=s.substring(0,s.indexOf("/"))),s.indexOf(":")!==-1&&(s=s.substring(0,s.indexOf(":"))),s.indexOf("?")!==-1&&(s=s.substring(0,s.indexOf("?"))),s.indexOf("#")!==-1&&(s=s.substring(0,s.indexOf("#"))),s.toLowerCase()):"undefined"}function Re(s){return s.indexOf("://")===-1?"https://":(s=s.substring(0,s.indexOf("://")+"://".length),s.toLowerCase())}let It=["com","co.uk","org.uk","net","org","de","ru","info","xyz","nl"];function Be(s){let t=$(s);try{for(let e in It){let a="."+It[e];if(Kt(t,a)){for(t=t.substring(0,t.length-a.length);t.indexOf(".")!==-1;)t=t.substring(t.indexOf(".")+1);t=t+a;break}}return t.indexOf("www.")===0&&(t=t.substring("www.".length)),t}catch{return t}}function Nt(s){s.noCacheRandom=$t()}function $t(){return new Date().getTime()+Math.round(Math.random()*1e4)+""}async function jt(s,t){Nt(t);let e=JSON.stringify(t);return await(await Jt(s,e)).json()}async function Jt(s,t){let e={};t?(e.method="POST",e.body=t):e.method="GET",e.headers=new Headers,e.headers.append("Content-Type","text/json");let a=await fetch(s,e);if(a.status===200)return a;throw new Error("http response code"+a.status)}function qt(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{let t=Math.random()*16|0;return(s=="x"?t:t&3|8).toString(16)})}const Ht="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split("");function _(s,t){let e=Ht,a=[],i=0;for(t=t||e.length,s=s||22,i=0;i<s;i++)a[i]=e[0|Math.random()*t];return a.join("")}function D(){return _()}function dt(){return D()}function Le(s){return s==null?"":s.replace(/^\s+/,"").replace(/\s+$/,"")}function Vt(...s){return(t,e)=>s.reduce((a,i)=>a||i(t,e),0)}function ve(s){return(t,e)=>s(t)-s(e)}function ht(s){return(t,e)=>s(e)-s(t)}const bt=(s,t)=>!!t.starred-!!s.starred||s.starred&&t.starred&&t.starredDate-s.starredDate||t.createDate-s.createDate;function tt(s){return s||(s=""),s.replace(/[\x00-\x1F\x7F-\x9F]/g,"")}function Kt(s,t){return s?s.indexOf(t,s.length-t.length)!==-1:!1}const zt={restoreWindow:"newWindow",pinnedTabs:"ignore",startupLaunch:"displayOneTab",restoreRemoval:"default",duplicates:"allow",pinned:"true"};function P(s,t){return t[s]?t[s]:zt[s]}function Ue(s,t,e){s.parentNode&&s.remove(),t.insertBefore(s,e===void 0||e>=t.children.length||t.children.length===0?null:t.children[Math.max(0,e)])}function Ne(s,t,e){let a=t===void 0?s:document.createElement(t),i={};if(e){e.style&&Object.assign(a.style,e.style);for(let o of Object.keys(e))o!=="style"&&o!=="children"&&(a[o]=e[o]);if(e.children)for(const[o,l]of Object.entries(e.children))i[o]=l,a.appendChild(l instanceof HTMLElement?l:l.o);e.l&&a.appendChild(e.l),e.init&&e.init(a)}t!==void 0&&s&&s.appendChild(a);let n={o:a};return Object.assign(n,i),n}const Wt="about:reader?url=";function A(s){return s?s.indexOf(":")===-1?"https://"+s:s.indexOf(Wt)===0?decodeURIComponent(s.substring(Wt.length)):s.startsWith(`${L}placeholder.html?`)?new URLSearchParams(s.substring(s.indexOf("?"))).get("url"):s:""}function $e(s){return parseInt(s.match(/\d+/)[0])}const At=[...new Array(30)].map((s,t)=>parseInt(10+Math.pow(1.6,t)));function*ft(s){let t=0;for(;At.slice(0,t).reduce((e,a)=>e+a,0)<s;)yield At[t++]}async function Ct(s,t,e){let a=0;for(let i of ft(s)){if(await e(a))return;await h(i),a+=i}throw new Error(`Timeout waiting for condition ${t}`)}function g(s){let t=chrome.i18n.getMessage(s);return t||(console.log("No translation available for: "+s),s)}function je(s,t,e){return t=!1,((s||"").toLowerCase().startsWith("file:")||et(s))&&t?e?`data:text/html, <html><body><div id="placeholderUrl">${s}</div></body></html>`:`${L}placeholder.html?url=${encodeURI(s)}`:s}function et(s){for(let t of Qt)if(s.startsWith(t))return!0;return!!(!s||s===""||s.startsWith("chrome-devtools:"))}const Qt=["javascript:","about:",...["chrome://","edge://","data:"].filter(s=>!1),...["edge://","chrome://"].map(s=>["newtab","new-tab-page","print","network-error","badcastcrash","inducebrowsercrashforrealz","crash","crashdump","kill","hang","shorthang","gpuclean","gpucrash","gpuhang","memory-exhaust","memory-pressure-critical","memory-pressure-moderate","ppapiflashcrash","ppapiflashhang","quit","restart"].map(t=>`${s}${t}/`)).flat()];async function h(s){return new Promise(t=>setTimeout(t,s))}class Yt{async put(t,e){await chrome.storage.local.set({[t]:e})}async get(t){return(await chrome.storage.local.get([t]))[t]}async remove(t){return await chrome.storage.local.remove(t)}}const Xt=new Yt;function S(){return Xt}const Zt="undefined-34LKmiHxP3Mu48u8qrDaHf";function Tt(s,t,e){return Array.isArray(s)?s.map(a=>Tt(a,t,e)):typeof s=="object"&&s!==null?Object.fromEntries(Object.entries(s).map(([a,i])=>[a,Tt(i,t,e)])):s===t?e:s}const O="c",x="e",R="tg";class _t{async put(t,e){await chrome.storage.session.set({[t]:e})}async get(t){return(await chrome.storage.session.get([t]))[t]}async getAll(){return await chrome.storage.session.get(null)}async remove(t){return await chrome.storage.session.remove(t)}async clearAll(){await chrome.storage.session.clear()}}class te{async put(t,e){await S().put("sessionStore",{...await this.getAll(),[t]:e})}async get(t){return(await this.getAll())[t]}async getAll(){return await S().get("sessionStore")??{}}async remove(t){let e=await this.getAll();delete e[t],await S().put("sessionStore",e)}async clearAll(){await S().remove("sessionStore")}}const ee=chrome.storage.session?new _t:new te;function E(){return ee}function Ot(){return!0}async function Et(s){let[t]=await chrome.tabs.query({windowId:s.windowId,active:!0});t&&t.id!==s.id?(await chrome.tabs.update(s.id,{active:!0}),await chrome.tabs.update(t.id,{active:!0})):console.log("No active tab found")}class j{constructor(t={}){this.xt=[],this.locked=!1,this.debug=!1,this.Wt=t}async It(){if(this.debug&&console.log(`lock ${this.Wt.label}: begin acquire attempt, queue len: ${this.xt.length}`),this.locked){if(this.debug&&console.log(`lock ${this.Wt.label}: waiting to acquire, queue len: ${this.xt.length}`),this.Wt.de)for(this.debug&&this.xt.length>0&&console.log(`lock ${this.Wt.label}: rejecting ${this.xt.length} queuers`);this.xt.length>0;)this.xt.shift().resolve(!1);let t=await new Promise((e,a)=>{this.xt.push({resolve:e,reject:a})});return this.debug&&(t?console.log(`lock ${this.Wt.label}: acquired after waiting, queue len: ${this.xt.length}`):console.log(`lock ${this.Wt.label}: acquisition rejected`)),t}else return this.locked=!0,this.debug&&console.log(`lock ${this.Wt.label}: acquired, queue len: ${this.xt.length}`),!0}release(){this.debug&&console.log(`lock ${this.Wt.label}: begin release, queue len: ${this.xt.length}`),this.xt.length===0?this.locked=!1:(this.xt.shift().resolve(!0),this.debug&&console.log(`lock ${this.Wt.label}: waiting thread notified. queue len: ${this.xt.length}`)),this.debug&&console.log(`lock ${this.Wt.label}: released. queue len: ${this.xt.length}`)}}class F{static he=6e4;static getKey(t){return`sessionStoreLock-${t}`}static async be(t){let e=await E().get(F.getKey(t)),a=new Date().getTime();return e&&a-e>F.he&&(console.log(`Warning: timed out sessionStore lock for id ${t}`),await F.release(t)),!!(e&&a-e<F.he)}static async It(t){return await this.be(t)?!1:(await E().put(F.getKey(t),new Date().getTime()),!0)}static async release(t){await E().remove(F.getKey(t))}}class U{constructor(){this.Re=[],this.fe=new j({label:"openOneTabOnStartLock"}),this.Te=new j({label:"duplicateCheck"}),this.pe=new j({label:"stateLock"}),this.Et=new j({label:"settingsLock"}),this.Be=!1}async U(){return{pong:String(ut)}}Dt(t){return this.Be&&(t||"").toLowerCase().startsWith("file:")?`${L}placeholder.html?url=${encodeURI(t)}`:t}async Le(){await this.Et.It();try{let t=await S().get("extensionKey");return t||(t=qt(),await S().put("extensionKey",t)),t}finally{this.Et.release()}}async Kt(t){let e=await at(!1);for(let a=0;a<e.length;a++)await this.Rt({Bt:e[a],Lt:!0,vt:t,X:a===0})}async kt(t){let e=ce(t),a=!0;if(!1)try{}catch(l){}let i=await G(),n=i.filter(l=>[l.url,l.pendingUrl].some(u=>u===e)),o=n.length>0?n[0]:void 0;n.length>1&&n.filter(l=>l!==o).forEach(l=>C(l)),o?(a&&ne(o),o=i.find(l=>[l.url,l.pendingUrl].some(u=>u===e)),await v(o)):await it(e,!1,!0)}async ye(t,e){let a=await Z(),i=a&&t.groupType==="tabGroup",n=t.tabsMeta.filter(f=>!et(f.url)),o=await this.getSettings(),l=P("restoreWindow",o);e==="currentWindow"&&(l="currentWindow"),e==="newWindow"&&(l="newWindow");let w=(await J()).tabs.filter(f=>!(f.pinned||I(f.url)||ae(f.url))).length,d=[],b;if(l==="currentWindow"||l==="newWindow"&&e!=="newWindow"&&w===0){b=await q(!1);for(const[f,m]of n.entries()){let T={active:!1,url:this.Dt(m.url)};b!==void 0&&(T.windowId=b.id),T.pinned=!i&&!!m.pinned;try{let M=await B(T);d.push(M)}catch(M){console.log(M)}}}else{let{zt:f,Qt:m}=await yt(n.map(T=>({...T,pinned:!i&&T.pinned})));b=f,d.push(...m)}if(i){let f=await chrome.tabs.group({createProperties:{windowId:b.id},tabIds:d.map(T=>T.id)}),m={};t.color&&(m.color=t.color),t.label&&(m.title=t.label),Object.keys(m).length>0&&a&&await chrome.tabGroups.update(f,m)}await this.ve()}async Z(t){let e=await this.getState(),a=t.split(`
`),i=new Date().getTime(),n=()=>({createDate:i--,tabsMeta:[],id:_()}),o=n(),l=[];for(let d of a)if(!d)o.tabsMeta.length>0&&(l.push(o),o=n());else{let b,f;d.indexOf(" | ")!==-1?(b=A(d.substring(0,d.indexOf(" | "))),f=d.substring(d.indexOf(" | ")+" | ".length)):(b=A(d),f=$(b)),o.tabsMeta.push({id:D(),url:b,title:tt(f)})}o.tabsMeta.length>0&&l.push(o);let u=Math.max(0,e.tabGroups.findIndex(d=>!d.starred)),w=l.map((d,b)=>({type:"createTabGroup",tabGroupId:d.id,tabGroup:d,index:u+b}));for(let d of w)await this.Mt(d)}async Mt(t,e){await this.pe.It();try{let a=await this.getState();if(t.type==="createTabGroup")e?a.tabGroups.splice(a.tabGroups.findIndex(i=>i.id===t.tabGroupId),1):a.tabGroups.splice(t.index,0,t.tabGroup);else if(t.type==="createTabs"){let i=a.tabGroups.find(n=>n.id===t.tabGroupId);if(!e)i.tabsMeta.unshift(...t.newTabsMeta);else{let n=new Set(t.newTabsMeta.map(o=>o.id));i.tabsMeta=i.tabsMeta.filter(o=>!n.has(o.id))}}else if(t.type==="deleteTabs"){let i=a.tabGroups.find(n=>n.id===t.tabGroupId);if(e){let n=[];t.tabsMetaDeleted.forEach((o,l)=>n.push([o,t.tabIndicesDeleted[l]])),n.sort((o,l)=>o[1]-l[1]),n.forEach(([o,l])=>i.tabsMeta.splice(l,0,o))}else{let n=new Set(t.tabMetaIds);i.tabsMeta=i.tabsMeta.filter(o=>!n.has(o.id))}}else if(t.type==="deleteTabGroup")if(e)a.tabGroups.splice(Math.max(0,t.index),0,t.deletedTabGroup);else{let i=a.tabGroups.findIndex(n=>n.id===t.tabGroupId);a.tabGroups.splice(i,1)}else if(t.type==="updateTabGroup"){let i=e?"old":"new",n=e?"new":"old",o=a.tabGroups,l=o.find(w=>w.id===t.tabGroupId),u=t.propChanges;u.starred&&(l.starred=u.starred[i],l.starredDate=u.starredDate[i]),u.label&&(l.label=u.label[i]),u.locked&&(l.locked=u.locked[i]),u.groupType&&(l.groupType=u.groupType[i]),u.index&&o.splice(u.index[i],0,...o.splice(u.index[n],1))}else if(t.type==="reorderTab"){let i=a.tabGroups.find(u=>u.id===t.tabGroupId),n=i.tabsMeta.findIndex(u=>u.id===t.tabMetaId),o=i.tabsMeta[n],l=t.newIndex;e&&(l=n,n=t.newIndex),i.tabsMeta.splice(n,1),i.tabsMeta.splice(Math.min(l,i.tabsMeta.length),0,o)}else if(t.type==="moveTabBetweenTabGroups"){let i=a.tabGroups.findIndex(l=>l.id===t.sourceTabGroupId),n=a.tabGroups[i],o=a.tabGroups.find(l=>l.id===t.targetTabGroupId);if(e){let l=o.tabsMeta.findIndex(w=>w.id===t.tabMetaId),u=o.tabsMeta.splice(l,1)[0];t.deletedSourceTabGroup?a.tabGroups=a.tabGroups.splice(t.sourceTabGroupIndex,0,t.deletedSourceTabGroup):n.splice(t.sourceTabGroupTabIndex,0,u)}else{let l=n.tabsMeta.findIndex(w=>w.id===t.tabMetaId),u=n.tabsMeta.splice(l,1)[0];o.tabsMeta.splice(t.targetTabGroupTabIndex,0,u),t.deletedSourceTabGroup&&(a.tabGroups=a.tabGroups.filter(w=>w.id!==t.deletedSourceTabGroup.id))}}await this.Ut(a),await this.Ue(t,e)}finally{this.pe.release()}}async Ne(){let t=await this.getState(),e=[],a=new Date().getTime();for(let o=0;o<200;o++){let l={createDate:a--,tabsMeta:[],label:"tab group "+o,id:_()};e.push(l);for(let u=0;u<20;u++)l.tabsMeta.push({id:D(),url:"https://en.wikipedia.org/wiki/"+(20*o+u),title:"wikipedia "+(20*o+u)})}let i=Math.max(0,t.tabGroups.findIndex(o=>!o.starred)),n=e.map((o,l)=>({type:"createTabGroup",tabGroupId:o.id,tabGroup:o,index:i+l}));for(let o of n)await this.Mt(o);await this.X()}async ve(){if((await r.me())?.pinned)return;if((await this.getState()).tabGroups.map(a=>a.tabsMeta.length).reduce((a,i)=>a+i,0)===0){let i=(await G()).find(n=>I(n.url));i&&await C(i)}}async getSettings(){let t=await S().get("settings");return t?JSON.parse(t):{}}async ft(t,e){await this.Et.It();try{let a=await this.getSettings();a[t]=e,await this.se(a)}finally{this.Et.release()}}async se(t){await S().put("settings",JSON.stringify(t))}async $e(t){let e=await this.getSettings();return P(t,e)}async getState(){let t=await S().get("state");return t?JSON.parse(t):{}}async Ut(t){await this.xe(t);let e=await S().get("state"),a=e;await S().put("state",JSON.stringify(t)),e=await S().get("state");try{JSON.parse(e)}catch{await S().put("state",a),console.log("Could not store extension state")}finally{}}async ge(t,e,a){let i={id:D(),url:A(t),title:tt(e)};await this.Me(i,a)}async je(t,e){if(I(t.url))return;let a={id:D(),url:A(t.url),title:tt(t.title)};["pinned","incognito"].filter(i=>t[i]).forEach(i=>a[i]=t[i]),await this.Me(a,e),await C(t)}async Me(t,e){if(t={...t},t.url=A(t.url),et(t.url)){console.log(`Cannot import tabs of this type: ${t.url}`);return}let a=await this.getState();if(e===void 0){let i=a.tabGroups.find(n=>!n.starred&&!n.locked);if(i)await this.Mt({type:"createTabs",tabGroupId:i.id,newTabsMeta:[t]});else{i={id:D(),tabsMeta:[t],createDate:new Date().getTime()};let n=Math.max(0,a.tabGroups.findIndex(o=>!o.starred));await this.Mt({type:"createTabGroup",tabGroupId:i.id,tabGroup:i,index:n})}}else await this.Mt({type:"createTabs",tabGroupId:e,newTabsMeta:[t]})}Ft(t,e,a){return t.pinned&&P("pinnedTabs",a)==="ignore"||I(e)||e.indexOf("chrome-devtools://")===0}Je(t,e,a){return ie(e)&&!I(e)||et(e)||P("duplicates",a)==="reject"&&t.tabGroups.some(i=>i.tabsMeta.some(n=>A(n.url)===e))}async Rt({Bt:t,Lt:e,vt:a,X:i}){if(!t.length)return;const n=Symbol();let o=await Z(),l=o?await chrome.tabGroups.query({windowId:t[0].windowId}):[],u=await this.getSettings(),w=await this.getState(),d=new Set((await G()).map(T=>T.id)),b=t.filter(T=>d.has(T.id)&&(!e||!this.Se(A(T.url),u)));b.sort((T,M)=>T.index-M.index);let f=[],m=[];for(let T of b){let M=T.url;!M&&T.pendingUrl&&(M=T.pendingUrl);let p=A(M);if(!this.Ft(T,p,u)){m.push(T);let V=f.find(N=>N[n]===T.groupId);if(!this.Je(w,p,u)&&!(V?.tabsMeta??[]).some(N=>N.url===p)){let N={id:D(),url:p,title:tt(T.title)};if(T.pinned&&(N.pinned=!0),!V){let lt=o&&T.groupId!==chrome.tabGroups.TAB_GROUP_ID_NONE&&l.find(Ut=>Ut.id===T.groupId);V={[n]:T.groupId,id:D(),tabsMeta:[],createDate:new Date().getTime(),...lt?{groupType:"tabGroup",color:lt.color,label:lt.title}:{}},f.push(V)}V.tabsMeta.push(N)}}}for(let T of f)delete T[n];if(f.length)if(a===void 0){let T=Math.max(0,w.tabGroups.findIndex(p=>!p.starred)),M=0;for(let p of f)await this.Mt({type:"createTabGroup",tabGroupId:p.id,tabGroup:p,index:T+M++})}else{let T=f.flatMap(M=>M.tabsMeta);await this.Mt({type:"createTabs",tabGroupId:a,newTabsMeta:T})}m.length===0?await r.X(!1,void 0):await oe(m,i)}Se(t,e){return this.Yt($(t),e)}Yt(t,e){if(e.excludedDomains){for(let a of e.excludedDomains)if(a===t)return!0}return!1}async Ge(t){await this.Et.It();try{let e=await this.getSettings();this.Yt(t,e)||(e.excludedDomains||(e.excludedDomains=[]),e.excludedDomains.push(t),await this.se(e))}finally{this.Et.release()}}async re(t){await this.Et.It();try{let e=await this.getSettings();if(!e.excludedDomains)return;e.excludedDomains=e.excludedDomains.filter(a=>a!==t),await this.se(e)}finally{this.Et.release()}}async xe(t){let e=!1;return t.tabGroups.forEach(a=>{a.tabsMeta&&a.tabsMeta.some(i=>!i)&&(a.tabsMeta=a.tabsMeta.filter(i=>i),e=!0)}),t.tabGroups.some(a=>!a.tabsMeta||!a.tabsMeta.length)&&(e=!0,t.tabGroups=t.tabGroups.filter(a=>a.tabsMeta&&a.tabsMeta.length)),e&&console.log("State fixed"),e}async qe(){await S().get("installDate")||await S().put("installDate",new Date().getTime());let e=await this.getState();e.tabGroups||(e.tabGroups=[],await this.Ut(e)),await this.xe(e)&&await this.Ut(e),[...e.tabGroups].sort(bt).every((a,i)=>a===e.tabGroups[i])||(console.log("Tabgroups correctly reordered"),e.tabGroups.sort(bt),await this.Ut(e))}async He(t){await this.X(!1,t)}async oe(t,e){let{activeTab:a}=await K(e?.windowId);await this.je(a,t)}async Ve(t,e,a){let n=t.linkUrl,o=t.frameId,l=o!==void 0?[o]:[],u=t.linkTitle;if(u||(u=t.linkText),u)await this.ge(n,u,a);else{await chrome.scripting.executeScript({target:{tabId:e.id,frameIds:l},files:["ext-onetab-concatenated-sources-contentscript.js"]});let w=await new Promise((b,f)=>{chrome.tabs.sendMessage(e.id,{type:"getLinkTitle",url:n},{frameId:o},m=>{chrome.runtime.lastError?f(chrome.runtime.lastError.message):b(m.title)})});await this.ge(n,w,a);let d="Pbclevtug BarGno Ygq jjj.bar-gno.pbz"}}async At(t,e){let{tabs:a,activeTab:i}=await K(e?.windowId),n=a.filter(o=>o.groupId===i.groupId);if(n.length===1&&I(i.url)){let o=a.find(l=>l.groupId!==i.groupId);o&&(n=a.filter(l=>l.groupId===o.groupId))}await this.Rt({Bt:n,Lt:!0,vt:t,X:!0})}async Ie(t,e){let{tabs:a,activeTab:i}=await K(e?.windowId);a=a.filter(o=>o.groupId===i.groupId);let n=[];if(i){for(let o of a)parseInt(o.index)!==parseInt(i.index)&&n.push(o);n.length>0&&await this.Rt({Bt:n,Lt:!0,vt:t,X:!1})}else console.log("no active tab")}async We(t,e){let{tabs:a,activeTab:i}=await K(e?.windowId);a=a.filter(o=>o.groupId===i.groupId);let n=[];if(i){for(let o of a)parseInt(o.index)<parseInt(i.index)&&n.push(o);n.length>0&&await this.Rt({Bt:n,Lt:!0,vt:t,X:!1})}}async Ae(t,e){let{tabs:a,activeTab:i}=await K(e?.windowId);a=a.filter(o=>o.groupId===i.groupId);let n=[];if(i){for(let o of a)parseInt(o.index)>parseInt(i.index)&&n.push(o);n.length>0&&await this.Rt({Bt:n,Lt:!0,vt:t,X:!1})}}async St(){return await r.$e("pinned")==="true"}async Fa(t){await this.Te.It();try{if(await mt(t)===void 0)return!1;let a=(await G()).filter(n=>I(n.url)&&n.id!==t),i;if(i=a,await Promise.all(i.slice(1).map(n=>pt(n.id))),i.length){let n=i[0];return await v(n),await nt(n.id),await pt(t),!0}else return await nt(t),!1}catch(e){return console.log(e),!1}finally{this.Te.release()}}async X(t,e){let a=!t,i=await G(),n=await q(!1),o=i.filter(l=>[l.url,l.pendingUrl].some(u=>I(u))).sort(Vt(ht(l=>l.windowId===e),ht(l=>!!l.active),...n&&!n?.incognito?[ht(l=>l.windowId===n.id)]:[])).find(()=>!0);if(o)await Promise.all(i.filter(l=>!(l.pinned&&!1)&&[l.url,l.pendingUrl].some(u=>I(u))&&l.id!==o.id).map(l=>C(l))),a&&await v(o);else{let l={url:c,...await this.St()?{pinned:!0,index:0}:{},active:a},u=!1;if(e!==void 0)l.windowId=e;else{let w=n;if(w?.incognito&&(w=(await k(!1)).find(d=>!d.incognito)),w)l.windowId=w.id;else{u=!0;let d=await Ft({});if(d?.id){let b=await E().get("lastCreateNewWindowTrigger");b&&new Date().getTime()-b<5e3||(await E().put("lastCreateNewWindowTrigger",new Date().getTime()),await this.X(t,d.id))}}}u||await B(l)}}static Nt(t,e,a,i){t[e]={old:a[e],new:i[e]}}async Da(t,e){let i=(await this.getState()).tabGroups,n=i.find(u=>u.id===t),o={},l=!1;if(e.hasOwnProperty("starred")&&(U.Nt(o,"starred",n,e),U.Nt(o,"starredDate",n,e)),e.hasOwnProperty("label")&&(U.Nt(o,"label",n,e),l=!0),e.hasOwnProperty("locked")&&U.Nt(o,"locked",n,e),e.hasOwnProperty("groupType")&&U.Nt(o,"groupType",n,e),e.hasOwnProperty("starred")){n.starred=e.starred,n.starredDate=e.starredDate;let u=i.findIndex(d=>d.id===t),w=[...i].sort(bt).findIndex(d=>d.id===t);o.index={old:u,new:w}}await this.Mt({type:"updateTabGroup",tabGroupId:t,propChanges:o}),l&&X()}async Ra(t,e){let i=(await this.getState()).tabGroups,n=i.findIndex(b=>b.id===t),o=i[n],l=JSON.parse(JSON.stringify(o)),u=o.tabsMeta.find(b=>b.id===e),w=o.tabsMeta.findIndex(b=>b.id===e);o.tabsMeta.length===1&&o.tabsMeta[0].id===e?(await this.Mt({type:"deleteTabGroup",tabGroupId:o.id,deletedTabGroup:l,index:n}),o.label&&X()):await this.Mt({type:"deleteTabs",tabGroupId:o.id,tabMetaIds:[e],tabsMetaDeleted:[u],tabIndicesDeleted:[w]})}async Ba(t,e,a){let i=await this.getState(),n=i.tabGroups.findIndex(l=>l.id===t),o=i.tabGroups[n];await this.Mt({type:"deleteTabGroup",tabGroupId:o.id,deletedTabGroup:o,index:n}),o.label&&X(),e&&await this.ye(o,a)}async La(t,e,a){let n=(await this.getState()).tabGroups.find(w=>w.id===t),o=n.tabsMeta.findIndex(w=>w.id===e),l=n.tabsMeta[o],u;a!==void 0?u=n.tabsMeta.filter(w=>w.id!==e).findIndex(w=>w.id===a):u=Math.max(0,n.tabsMeta.length-1),await this.Mt({type:"reorderTab",tabMetaId:l.id,tabGroupId:n.id,oldIndex:o,newIndex:u})}async va(t,e,a,i){let n=await this.getState(),o=n.tabGroups.findIndex(T=>T.id===t),l=n.tabGroups[o],u=JSON.parse(JSON.stringify(l)),w=l.tabsMeta.findIndex(T=>T.id===a),d=n.tabGroups.find(T=>T.id===e),b;i!==void 0?b=d.tabsMeta.findIndex(T=>T.id===i):b=d.tabsMeta.length;let f=l.tabsMeta.length===1&&l.tabsMeta[0].id===a,m={type:"moveTabBetweenTabGroups",tabMetaId:a,sourceTabGroupId:l.id,targetTabGroupId:d.id,sourceTabGroupTabIndex:w,targetTabGroupTabIndex:b,sourceTabGroupIndex:o};f&&(m.deletedSourceTabGroup=u),await this.Mt(m),f&&l.label&&X()}Ua(t){this.Re=[t]}async me(){return(await chrome.tabs.query({})).find(t=>t.url?.startsWith(c))}async Ue(t,e){let a={Na:t,undo:e},i=await this.me();if(i){Ot()&&+new Date-(await E().get("aliveIndicator")??0)>2e4&&await Et(i);try{let n=!1;Ot()&&setTimeout(()=>{n||Et(i)},1e3);let o=await chrome.tabs.sendMessage(i.id,{type:"stateChange",F:a});return n=!0,o}catch{}}}async $a(t,e){let a=new Set(t||[]),i=await jt(St+"/api/createPage",{key:await r.Le(),tabGroups:(await this.getState()).tabGroups.filter(n=>e||a.has(n.id))});await it(i.url,!1,!0)}async ja(t,e){let n=(await r.getState()).tabGroups.find(o=>o.id===t);await r.ye(n,e)}async Ke(){return await it(...arguments)}async ze(){return await B(...arguments)}async Ja(){return await yt(...arguments)}async it(t,e){e||(e={});let a=(await G()).find(i=>I(i.url));if(!a)throw new Error("OneTab tab not found");try{return await new Promise((i,n)=>{chrome.tabs.sendMessage(a.id,{type:t,...e},o=>{chrome.runtime.lastError?n(chrome.runtime.lastError.message):o&&o.error?n(o.error):i(o)})})}catch(i){throw new Error(i)}}async Tt(){return await E().get("contextMenuState")??{}}async le(t){await E().put("contextMenuState",t)}async Qe(){await S().put("lastSeenVersion","restoreTest"),await vt()}async Ye(t){await new Lt().Ce(t)}async Xe(t,e){for(let a=0;a<t;a++)await new Lt().Ce(e)}async Oe(){let t=await r.getSettings();return P("oneTabTabState",t)||{}}async ue(t){await r.ft("oneTabTabState",t)}async qa(t){let e=await this.Oe();Object.entries(t).forEach(([a,i])=>e[a]=i),await this.ue(e)}}async function Pt(){return new Promise((s,t)=>{chrome.tabs.query({active:!0,currentWindow:!0},e=>{chrome.runtime.lastError?t(chrome.runtime.lastError.message):e&&e.length===1?s(e[0]):t("No current tab found")})})}function ae(s){return!!(s===""||he.some(t=>s.indexOf(t)===0))}function I(s){return s&&s.indexOf(c)===0}function ie(s){return s&&s.indexOf(L)===0}async function K(s){if(s!==void 0){let t=await chrome.tabs.query({windowId:s});return{tabs:t,activeTab:t.find(e=>e.active)}}else return await J()}async function J(){return new Promise((s,t)=>{(async()=>{let e={};if(chrome.windows){let a=await q(!1);if(a===void 0){s(void 0);return}e={windowId:a.id}}chrome.tabs.query(e,a=>{if(chrome.runtime.lastError)t(chrome.runtime.lastError.message);else{let i;for(let n of a)if(n.active){i=n;break}s({tabs:a,activeTab:i})}})})()})}async function se(s){return new Promise((t,e)=>{(async()=>chrome.tabs.query({windowId:s},a=>{if(chrome.runtime.lastError)e(chrome.runtime.lastError.message);else{let i;for(let n of a)if(n.active){i=n;break}t({tabs:a,activeTab:i})}}))()})}async function G(){return new Promise((s,t)=>{chrome.tabs.query({},e=>{chrome.runtime.lastError?t(chrome.runtime.lastError.message):s(e)})})}async function at(s){let t;return chrome.windows&&(t=await q(!1)),new Promise((e,a)=>{chrome.tabs.query({},i=>{if(chrome.runtime.lastError)a(chrome.runtime.lastError.message);else{let n=new Map;for(let l of i){let u=l.windowId;s&&t&&u===t.id||(n.has(u)||n.set(u,[]),n.get(u).push(l))}let o=Array.from(n.values());e(o)}})})}async function ne(s){return new Promise((t,e)=>{chrome.tabs.reload(s.id,{},()=>{chrome.runtime.lastError?e(chrome.runtime.lastError.message):t()})})}async function C(s){return await pt(s.id)}async function pt(s){return new Promise((t,e)=>{chrome.tabs.remove(s,()=>{chrome.runtime.lastError&&console.log(chrome.runtime.lastError.message),t()})})}async function kt(s){return new Promise((t,e)=>{chrome.windows.remove(s,()=>{chrome.runtime.lastError?e(chrome.runtime.lastError.message):t()})})}function re(s,t){let e=new Map;return s.forEach(a=>{let i=a[t];e.has(i)||e.set(i,[]),e.get(i).push(a)}),e}async function oe(s,t){if(s.length===0)return;let e=s.some(w=>!w.pinned)?s.find(w=>!w.pinned).windowId:s[0].windowId,a=!!(await k(!1)).find(w=>w.id===e).incognito,i=await G(),n=re(i,"windowId"),o=n.get(e).filter(w=>!w.pinned&&!s.some(d=>d.id===w.id)).length===0,l=n.get(e).filter(w=>!s.some(d=>d.id===w.id)).length>0,u=(await k(!0)).filter(w=>!w.incognito&&w.id!==e);if(u.length>0)if(!l||!1)t?await r.X(!1,u[0].id):await v(u[0].tabs[0]),await kt(e);else{if(t){let d=a?u[0].id:e;await r.X(!1,d)}await Promise.all(s.map(d=>C(d)))}else t&&await r.X(!1,a?void 0:e),await Promise.all(s.map(w=>C(w)))}async function v(s){return new Promise((t,e)=>{chrome.tabs.update(s.id,{active:!0},()=>{chrome.runtime.lastError?e(chrome.runtime.lastError.message):chrome.windows?chrome.windows.update(s.windowId,{focused:!0},()=>{chrome.runtime.lastError?e(chrome.runtime.lastError.message):t()}):t()})})}async function B(s){return s={...s},chrome.windows||delete s.windowId,new Promise((t,e)=>{chrome.tabs.create(s,a=>{chrome.runtime.lastError?e(chrome.runtime.lastError.message):t(a)})})}async function Ft(s){return new Promise((t,e)=>{chrome.windows.create(s,a=>{chrome.runtime.lastError?e(chrome.runtime.lastError.message):t(a)})})}async function Je(s,t){return new Promise((e,a)=>{chrome.tabs.move(s,{index:t},()=>{chrome.runtime.lastError?a(chrome.runtime.lastError.message):e()})})}async function k(s){return new Promise((t,e)=>{chrome.windows.getAll({populate:!!s},a=>{chrome.runtime.lastError?e(chrome.runtime.lastError.message):t(a)})})}async function q(s){return new Promise((t,e)=>{chrome.windows.getLastFocused({populate:!!s},a=>{chrome.runtime.lastError?t(void 0):t(a)})})}async function it(s,t,e,a={}){if(a.url=s,a.pinned=!!t,a.active=!!e,chrome.windows){let i=await q(!1);i&&(a.windowId=i.id)}return await B(a)}async function yt(s){let t=await chrome.windows.create({url:r.Dt(s[0].url)}),e=[],a=await chrome.tabs.query({windowId:t.id}),i=!!s[0].pinned,n=a[a.length-1];i&&await chrome.tabs.update(n.id,{pinned:!0}),e.push(n);for(let o of s.slice(1)){let l=await B({url:r.Dt(o.url),pinned:!!o.pinned,windowId:t.id});e.push(l)}return{zt:t,Qt:e}}function le(){chrome.commands.onCommand.addListener(s=>{(async()=>(s==="display-onetab"&&await r.X(),s==="send-current-tab-to-onetab"&&await r.oe(),s==="send-all-tabs-in-current-window-to-onetab"&&await r.At(),s==="send-all-tabs-in-all-windows-to-onetab"&&await r.Kt(void 0),s==="send-all-tabs-except-this-to-onetab"&&await r.Ie(void 0,void 0)))()})}function ue(s){["onCreated","onUpdated","onMoved","onRemoved","onReplaced","onDetached","onAttached","onActivated"].forEach(t=>chrome.tabs[t].addListener(()=>s())),["onFocusChanged","onCreated","onRemoved"].forEach(t=>chrome.windows[t].addListener(()=>s()))}let st;async function Dt(){if(st)return st.value;{let s=await E().get("oneTabTabId");return st={value:s},s}}async function nt(s){st={value:s},s===void 0?await E().remove("oneTabTabId"):await E().put("oneTabTabId",s)}async function rt(s){await r.ft("pinned",`${!!s}`)}function we(){chrome.tabs.onRemoved.addListener(async(s,{windowId:t,isWindowClosing:e})=>{s===await Dt()&&await nt(void 0)}),chrome.tabs.onUpdated.addListener(async(s,t,e)=>{try{let a=[e.url,e.pendingUrl].some(n=>I(n));s===await Dt()&&!a&&e.pinned&&(await nt(void 0),await z(s,{pinned:!1})),a&&Object.hasOwn(t,"pinned")&&await rt(t.pinned)}catch(a){console.log(a)}})}function ce(s){return chrome.runtime.getURL(s)}async function de(){chrome.runtime.reload()}const he=[...["newtab","home","welcome","welcomeback"].map(s=>"about:"+s),...["newtab","new-tab-page"].map(s=>wt+s+"/")];async function mt(s){return new Promise((t,e)=>{chrome.tabs.get(s,a=>{chrome.runtime.lastError?t(void 0):t(a)})})}async function Rt(s){return new Promise((t,e)=>{chrome.tabs.query({},a=>{chrome.runtime.lastError?e(chrome.runtime.lastError.message):t(a.filter(i=>i.url===s))})})}async function xt(s){let t=await Rt(s);if(t.length===0)throw new Error("No tab found with URL: "+s);if(t.length>1)throw new Error("More than one tab found with URL: "+s);return t[0]}async function z(s,t){return new Promise((e,a)=>{chrome.tabs.update(s,t,()=>{chrome.runtime.lastError?a(chrome.runtime.lastError.message):e()})})}async function gt(s,t){s!==void 0&&(t.parentId=s);let e={};return e.id=dt(),t.id=e.id,t.title!==void 0&&(t.title=String(t.title).replaceAll("&","&&")),await chrome.contextMenus.create(t),e}async function Mt(s,t){s[x]=+!!t,await chrome.contextMenus.update(s.id,{enabled:t})}async function be(s,t){s[O]=+!!t,await chrome.contextMenus.update(s.id,{type:"checkbox",checked:t})}async function fe(s,t,e){e&&(s.title=t),await chrome.contextMenus.update(s.id,{title:t})}async function W(s,t,e){s!==void 0&&(e.parentId=s.id);let a={[O]:+!!e.checked,[x]:+!!e.enabled,id:dt().slice(0,10)};return t&&(a[R]=t,a[O]=1,a[x]=1),e.id=a.id,await chrome.contextMenus.create(e),a}async function Te(){await chrome.contextMenus.removeAll()}async function ot(s){let t={type:"separator",contexts:["all"],id:dt().slice(0,10)};s&&(t.parentId=s.id),await chrome.contextMenus.create(t)}function pe(s){s.rootContextMenu=void 0,s.displayOneTabMenu=void 0,s.namedTabGroupsMenu=void 0,s.sendAllTabsInCurrentWindowMenus=[],s.sendCurrentTabMenus=[],s.sendTabsToTheLeftMenus=[],s.sendTabsToTheRightMenus=[],s.sendAllTabsInAllWindowsMenus=[],s.sendTabsExceptThisMenus=[],s.sendThisWebLinkMenus=[],s.excludeWebSiteContextMenu=void 0,s.helpMenu=void 0}async function H(s,t){await Promise.all(s.map(e=>e.map(a=>Mt(a,t)).flat()))}let Bt=new j({label:"updateContextMenuState",de:!0});async function Q(){let s=await r.Tt();if(!s.rootContextMenu||await q(!1)===void 0||Y.locked||await F.be("recreateContextMenus"))return;let t=!1;try{if(t=await Bt.It(),!t)return;let e=await r.getSettings(),a=await at(!0),i=await J();if(!i)return;let{tabs:n,activeTab:o}=i,l=I(o.url);await Mt(s.displayOneTabMenu,!l);let u=A(o.url);await Mt(s.excludeWebSiteContextMenu,!l);let w=u&&u.toLowerCase().indexOf("http")===0?g("excludeDomainFromOneTab").replace("DOMAIN.COM",$(u)):g("excludeWebSiteFromOneTab");await fe(s.excludeWebSiteContextMenu,w,!0),await be(s.excludeWebSiteContextMenu,r.Se(u,e));let d=!1,b=!1,f=!1,m=!1,T=!1;if(o){let M=parseInt(o.index);d=n.some(p=>parseInt(p.index)<M&&p.url&&!r.Ft(p,A(p.url),e)),b=n.some(p=>parseInt(p.index)>M&&p.url&&!r.Ft(p,A(p.url),e)),m=n.some(p=>p.url&&!r.Ft(p,A(p.url),e)),f=n.some(p=>p.id!==o.id&&p.url&&!r.Ft(p,A(p.url),e))}if(T=a.some(M=>M.some(p=>p.url&&!r.Ft(p,A(p.url),e))),await H([s.sendAllTabsInCurrentWindowMenus.slice(0,1)],m),await H([s.sendCurrentTabMenus.slice(0,1)],!(l||!m)),await H([s.sendTabsToTheLeftMenus.slice(0,1)],d),await H([s.sendTabsToTheRightMenus.slice(0,1)],b),await H([s.sendAllTabsInAllWindowsMenus.slice(0,1)],T),await H([s.sendTabsExceptThisMenus.slice(0,1)],f),Y.locked)return;await r.le(s)}catch(e){Y.locked||console.log(`updateContextMenuState warning: ${e}`)}finally{t&&Bt.release()}}let Y=new j({label:"recreateContextMenus",de:!0});async function X(){if(!chrome.contextMenus)return;let s,t=!1;try{if(t=await Y.It(),!t||(s=await F.It("recreateContextMenus"),!s))return;let e=await r.Tt();await Te(),pe(e),await me(e),await r.le(e)}finally{t&&(s&&await F.release("recreateContextMenus"),Y.release(),await Q())}}async function ye(){await r.le({})}async function me(s){s.rootContextMenu=await gt(void 0,{type:"normal",contexts:["all"],title:"OneTab"}),s.displayOneTabMenu=await W(s.rootContextMenu,void 0,{type:"normal",title:g("displayOneTab"),contexts:["all"]});let t=await W(s.rootContextMenu,void 0,{type:"normal",title:g("sendAllTabsToOneTab"),contexts:["all"]});s.sendAllTabsInCurrentWindowMenus.push(t);let e=await W(s.rootContextMenu,void 0,{type:"normal",title:g("sendThisWebLinkToOneTab"),contexts:["link"]});s.sendThisWebLinkMenus.push(e),await ot(s.rootContextMenu);let a=await W(s.rootContextMenu,void 0,{type:"normal",title:g("sendOnlyThisTabToOneTab"),contexts:["all"]});s.sendCurrentTabMenus.push(a);let i=await W(s.rootContextMenu,void 0,{type:"normal",title:g("sendAllTabsExceptThisToOneTab"),contexts:["all"]});s.sendTabsExceptThisMenus.push(i);let n=await W(s.rootContextMenu,void 0,{type:"normal",title:g("sendLeftTabsToOneTab"),contexts:["all"]});s.sendTabsToTheLeftMenus.push(n);let o=await W(s.rootContextMenu,void 0,{type:"normal",title:g("sendRightTabsToOneTab"),contexts:["all"]});s.sendTabsToTheRightMenus.push(o);let l=await W(s.rootContextMenu,void 0,{type:"normal",title:g("sendAllTabsAllWindowsToOneTab"),contexts:["all"]});s.sendAllTabsInAllWindowsMenus.push(l),await ot(s.rootContextMenu),s.excludeWebSiteContextMenu=await W(s.rootContextMenu,void 0,{type:"checkbox",checked:!1,contexts:["all"],title:g("excludeWebSiteFromOneTab")}),s.excludeWebSiteContextMenu.title=g("excludeWebSiteFromOneTab");let w=(await r.getState()).tabGroups;w||(w=[]),w=w.slice(0,500);let d=w.filter(b=>b.label&&b.label!=="");if(d.length){await ot(s.rootContextMenu),s.namedTabGroupsMenu=await gt(s.rootContextMenu.id,{type:"normal",contexts:["all"],title:g("namedTabGroups")});for(let b of d){let f=await gt(s.namedTabGroupsMenu.id,{type:"normal",contexts:["all"],title:b.label});s.sendAllTabsInCurrentWindowMenus.push(await W(f,b.id,{type:"normal",title:g("sendAllTabsToPlaceholder").replace("PLACEHOLDER",b.label),contexts:["all"]})),s.sendThisWebLinkMenus.push(await W(f,b.id,{type:"normal",title:g("sendThisWebLinkToPlaceholder").replace("PLACEHOLDER",b.label),contexts:["link"]})),s.sendCurrentTabMenus.push(await W(f,b.id,{type:"normal",title:g("sendOnlyThisTabToPlaceholder").replace("PLACEHOLDER",b.label),contexts:["all"]})),d.length&&(s.sendTabsExceptThisMenus.push(await W(f,b.id,{type:"normal",title:g("sendAllTabsExceptThisTabToPlaceholder").replace("PLACEHOLDER",b.label),contexts:["all"]})),s.sendTabsToTheLeftMenus.push(await W(f,b.id,{type:"normal",title:g("sendLeftTabsToPlaceholder").replace("PLACEHOLDER",b.label),contexts:["all"]})),s.sendTabsToTheRightMenus.push(await W(f,b.id,{type:"normal",title:g("sendRightTabsToPlaceholder").replace("PLACEHOLDER",b.label),contexts:["all"]})))}}await ot(s.rootContextMenu),s.helpMenu=await W(s.rootContextMenu,void 0,{type:"normal",title:g("help"),contexts:["all"]})}class Lt{async Ce(t){try{if(ct&&!await Z())throw new Error("Need tab groups permission");for(let e=0;e<2;e++){await this.dt(y);let a=e===0;await rt(a),console.log(`begin tests with pinned: ${a}`),await this.Ze(t.pdfFileUrl),await this._e(a),await this.ta(),await Z()&&(await this.ea(),await this.aa()),await this.ia(),await this.sa(),await this.na(),await this.ra(),await this.oa(),a&&await this.la(),await this.ua(),await this.wa(),await this.ca(),await this.da(),await this.Ee({ctrlKey:!0}),await this.Ee({metaKey:!0}),await this.ha(),await this.ba(),await this.fa(),await this.Ta(),await this.pa(),await this.ya(),await this.ma(),await this.xa(),await this.ga(),await this.Ma(),await this.Sa(),await this.Ga(),console.log(`tests completed with pinned: ${a}`)}console.log("all tests completed")}finally{let e=wt+"extensions/";await this.dt(e);let a=await r.getState();a.tabGroups=a.tabGroups.filter(i=>i.tabsMeta.every(n=>!(n.title.startsWith("t---")||n.title.startsWith("PIN::t---")||n.url.startsWith("http://localhost")||n.url===t.pdfFileUrl))),await r.Ut(a),await rt(!0),console.log("done.")}}async ia(){let t=await r.St();console.log("begin testAutoUnPin");let e={tt:[this.et(),this.et(),this.et()]};await this.ot(e,!0),await r.X(),await this.nt();let a=await xt(c);this.assert((await mt(a.id)).pinned===t),await z(a.id,{url:this.et()}),await h(200),this.assert(!(await mt(a.id)).pinned),await r.X(),await this.nt();let i=await xt(c);this.assert(i.pinned===t)}async sa(){console.log("begin testDuplicateOneTabTabAdded");let t={tt:[this.et(),this.et(),this.et()]};await this.ot(t,!0),await r.X(),await this.nt();let a=(await xt(c)).id;await B({url:c}),await B({url:c}),await h(500),this.assert((await Rt(c)).length===1),await this.yt(c),this.assert((await Pt()).id===a)}async ca(){console.log("begin testSimulateRestoreClick"),await this.dt(y);let t={tt:[this.et(),this.et(),this.et(),this.et()]};await this.ot(t,!0),await r.X(),await this.nt(),await r.At(),await r.it("clickTab",{url:t.tt[0],ut:{}}),await this.lt({tt:[c,t.tt[0]]}),await this.yt(c),await r.it("clickTab",{url:t.tt[1],ut:{shiftKey:!0}}),await this.Ia(t.tt[1]),await this.Ct(t.tt[1]),await r.it("clickTab",{url:t.tt[2],ut:{ctrlKey:!0}}),await h(300),await this.yt(c),await h(1e3),await this.rt({tt:[c,t.tt[0],t.tt[2]]}),await r.it("clickTab",{url:t.tt[3],ut:{metaKey:!0}}),await h(300),await this.yt(c),await h(1e3),await this.rt({tt:[c,t.tt[0],t.tt[2],t.tt[3]]}),await this.ct(0,[t.tt[1],t.tt[2],t.tt[3]])}async fa(){console.log("begin testTabsAddedToExistingGroup"),await this.dt(y);let t={tt:[this.et(),this.et(),this.et()]};await this.ot(t,!0),await r.X(),await this.nt();let e=await r.St();await this.lt({tt:e?[c,...t.tt]:[...t.tt,c]}),await r.At(),await this.ct(0,[...t.tt]),await this.lt({tt:[c]});let a={tt:[this.et()]};await this.ot(a,!1),await this.lt({tt:[c,a.tt[0]]}),await this.gt(a.tt[0]),await r.oe(),await h(200),await this.ct(0,[a.tt[0],...t.tt])}async da(){console.log("begin testSimulateRestoreTabGroupClick"),await this.dt(y);let t={tt:[this.et(),this.et(),this.et()]};await this.ot(t,!0),await r.X(),await this.nt(),await h(200),await r.At(),await this.ct(0,[...t.tt]),await this.lt({tt:[c]}),await r.it("clickTabGroupButton",{ht:"restoreAllButton",wt:t.tt[0],ut:{}}),await h(200),await this.Pt(0,t.tt[0]),await this.lt({tt:[c,...t.tt]}),await this.yt(c)}async Ee(t){console.log("begin testSimulateRestoreTabGroupCtrlOrMetaClick"),await this.dt(y);let e={tt:[this.et(),this.et(),this.et()]};await this.ot(e,!0),await r.X(),await this.nt(),await h(200),await r.At(),await h(200),await this.ct(0,[...e.tt]),await this.lt({tt:[c]}),await r.it("clickTabGroupButton",{ht:"restoreAllButton",wt:e.tt[0],ut:t}),await h(200),await this.ct(0,[...e.tt]),await this.lt({tt:[c,...e.tt]}),await this.yt(c)}async ha(){console.log("begin testSimulateRestoreTabGroupShiftClick"),await this.dt(y);let t={tt:[this.et(),this.et(),this.et()]};await this.ot(t,!0),await r.X(),await this.nt(),await h(200),await r.At(),await this.ct(0,[...t.tt]),await this.lt({tt:[c]}),await this.nt(),await r.it("clickTabGroupButton",{ht:"restoreAllButton",wt:t.tt[0],ut:{shiftKey:!0}}),await this.ct(0,[...t.tt]),await this.lt({tt:[...t.tt],other:[[c]]})}async ba(){console.log("begin testSimulateDeleteTabGroupClick"),await this.dt(y);let t={tt:[this.et(),this.et(),this.et()]};await this.ot(t,!0),await r.X(),await this.nt(),await h(200),await r.At(),await h(200),await this.ct(0,[...t.tt]),await this.Ot(t.tt,0,!0),await this.Wa(t.tt[0]),await this.nt(),await r.it("clickTabGroupButton",{ht:"deleteAllButton",wt:t.tt[0]}),await h(200),await this.Pt(0,t.tt[0]),await h(200),await this.Aa(t.tt[0])}async Pt(t){let e=await r.it("getVisibleStructure");this.assert(e.tabGroups.every(a=>!a.tabs.some(i=>i===t)))}async ct(t,e){await h(200);let a=await r.it("getVisibleStructure"),i=a.tabGroups.findIndex(n=>!n.we);this.assert(this.Pe([e],a.tabGroups.slice(i+t,i+t+1).map(n=>n.tabs)),`assertUnstarredTabGroup fail: expected: ${e}`)}async wa(){console.log("begin testOneTabTabUpdated"),await this.dt(y);let t={tt:[this.et(),this.et()],st:[[this.et(),this.et()],[this.et(),this.et()]]};await this.ot(t,!0),await r.X(!1),await this.nt();let e=await r.St();await this.rt({tt:e?[c,...t.st[1]]:[...t.st[1],c],other:[t.tt,...t.st.slice(0,-1)]}),await r.Kt(),await this.nt();let a=await r.it("getVisibleStructure");this.Gt(a.Ca,a.tabGroups.reduce((n,o)=>n+o.Oa,0),"visible total tab count === summed visible tabgroup counts"),this.Gt(a.Ca,a.tabGroups.reduce((n,o)=>n+o.tabs.length,0),"visible total tab count === summed visible tabs"),this.assert(a.tabGroups.every(n=>n.Oa===n.tabs.length));let i=a.tabGroups.findIndex(n=>!n.we);this.assert(a.tabGroups.every((n,o)=>o<i&&n.we||o>=i&&!n.we)),this.assert(this.Pe([t.tt,...t.st],a.tabGroups.slice(i,i+3).map(n=>n.tabs)))}Pe(t,e){return t.map(a=>a.join(" ")).sort().join(`
`)===e.map(a=>a.join(" ")).sort().join(`
`)}async ua(){if(console.log("begin testOneTabTabComms"),await r.X(!1),await this.nt(),!(await r.it("ping")).pong)throw new Error("comms test failed")}async ta(){console.log("begin testBrowserActionClick"),await this.dt(y);let t={tt:[this.et(),this.et()],st:[[this.et(),this.et()]]};await this.ot(t,!0),await this.rt({tt:t.st[0],other:[t.tt]}),await this.bt(),await this.nt();let e=await r.St();await this.rt({tt:e?[c,...t.tt]:[...t.tt,c],other:[]})}async ea(){console.log("begin testBrowserGroupSaveAndRestore");let t=[{Xt:3,$t:[0,1,2],jt:[3,4,5],Zt:!0,_t:async()=>await this.bt()},{Xt:1,$t:[3,4,5],jt:[0,1,2],Zt:!1,_t:async()=>await this.bt()},{Xt:5,$t:[0,1,2,5],jt:[3,4],Zt:!0,_t:async()=>(await r.We(),await r.X())},{Xt:3,$t:[0,1,2,3],jt:[4,5],Zt:!0,_t:async()=>(await r.Ae(),await r.X())}];for(let e of t){await this.dt(y);let a={tt:[this.et(),this.et(),this.et(),this.et(),this.et(),this.et()]},i=await this.ot(a,!0);await this.rt({tt:a.tt}),await chrome.tabs.group({createProperties:{windowId:i.tt[0].windowId},tabIds:i.tt.map(o=>o.id).slice(3)}),await this.gt(a.tt[e.Xt]),await e._t(),await this.nt();let n=await r.St();await this.rt({tt:n?[c,...e.$t.map(o=>a.tt[o])]:[...e.$t.map(o=>a.tt[o]),c]}),await this.Ot(e.jt.map(o=>a.tt[o]),0,!0),await this.nt(),this.assert((await r.it("getTabGroupElementDisplayed",{Jt:"tabGroupImg",wt:a.tt[e.jt[0]]})).qt===e.Zt)}}async aa(){console.log("begin testBrowserGroupSaveAndRestore2"),await this.dt(y);let t={tt:[this.et(),this.et(),this.et(),this.et(),this.et(),this.et()],st:[[this.et(),this.et()]]},e=await this.ot(t,!0);await this.rt({tt:t.st[0],other:[t.tt]}),await chrome.tabs.group({createProperties:{windowId:e.tt[0].windowId},tabIds:e.tt.map(i=>i.id).slice(1,3)}),await chrome.tabs.group({createProperties:{windowId:e.tt[0].windowId},tabIds:e.tt.map(i=>i.id).slice(4,6)}),await r.Kt(),await r.X(),await this.nt();let a=await r.St();await this.rt({tt:[c]}),await this.Ot([0,1].map(i=>t.st[0][i]),0,!0),await this.Ot([0,3].map(i=>t.tt[i]),1,!0),await this.Ot([1,2].map(i=>t.tt[i]),2,!0),await this.Ot([4,5].map(i=>t.tt[i]),3,!0),await r.it("clickTabGroupButton",{ht:"restoreAllButton",wt:t.tt[4],ut:{}}),await h(200),await this.Pt(0,t.tt[4]),await this.Pt(0,t.tt[5]),await this.lt({tt:[c,...t.tt.slice(4)]}),await this.yt(c)}async na(){console.log("begin testContextMenus"),await this.dt(y);let t={tt:[this.et(),this.et()],st:[[this.et(),this.et()],[this.Ht(),this.et(),this.et()]]};await this.ot(t,!0),await this.rt({tt:t.st[1],other:[t.tt,t.st[0]]});let e=500;const a=(l,u,w)=>{const d=l[u].length;this.assert(d>0),this.assert(l[u][0][x]===+w)};await this.gt(t.tt[0]),await h(e),await Q();let i=await r.Tt();a(i,"sendTabsToTheLeftMenus",!1),a(i,"sendTabsToTheRightMenus",!0),a(i,"sendAllTabsInAllWindowsMenus",!0),a(i,"sendTabsExceptThisMenus",!0),a(i,"sendAllTabsInCurrentWindowMenus",!0),this.assert(i.displayOneTabMenu[x]),this.assert(i.excludeWebSiteContextMenu[x]),this.assert(!i.excludeWebSiteContextMenu[O]),this.assert(i.excludeWebSiteContextMenu.title==="Exclude localhost from OneTab"),await this.gt(t.tt[1]),await h(e),i=await r.Tt(),a(i,"sendTabsToTheLeftMenus",!0),a(i,"sendTabsToTheRightMenus",!1),a(i,"sendAllTabsInAllWindowsMenus",!0),a(i,"sendTabsExceptThisMenus",!0),a(i,"sendAllTabsInCurrentWindowMenus",!0),a(i,"sendCurrentTabMenus",!0),this.assert(i.displayOneTabMenu[x]),this.assert(i.excludeWebSiteContextMenu[x]),this.assert(!i.excludeWebSiteContextMenu[O]),this.assert(i.excludeWebSiteContextMenu.title==="Exclude localhost from OneTab"),await this.gt(t.st[0][0]),await h(e),i=await r.Tt(),a(i,"sendTabsToTheLeftMenus",!1),a(i,"sendTabsToTheRightMenus",!0),a(i,"sendAllTabsInAllWindowsMenus",!0),a(i,"sendTabsExceptThisMenus",!0),a(i,"sendAllTabsInCurrentWindowMenus",!0),a(i,"sendCurrentTabMenus",!0),this.assert(i.displayOneTabMenu[x]),this.assert(i.excludeWebSiteContextMenu[x]),this.assert(!i.excludeWebSiteContextMenu[O]),this.assert(i.excludeWebSiteContextMenu.title==="Exclude localhost from OneTab"),await this.gt(t.st[1][1]),await h(e),i=await r.Tt(),a(i,"sendTabsToTheLeftMenus",!1),a(i,"sendTabsToTheRightMenus",!0),a(i,"sendAllTabsInAllWindowsMenus",!0),a(i,"sendTabsExceptThisMenus",!0),a(i,"sendAllTabsInCurrentWindowMenus",!0),a(i,"sendCurrentTabMenus",!0),this.assert(i.displayOneTabMenu[x]),this.assert(i.excludeWebSiteContextMenu[x]),this.assert(!i.excludeWebSiteContextMenu[O]),this.assert(i.excludeWebSiteContextMenu.title==="Exclude localhost from OneTab"),await r.X(),await this.nt();let n=await this.Vt(),o=await r.St();await this.rt({tt:o?[c,...t.st[1]]:[...t.st[1],c],other:[t.tt,t.st[0]]}),await this.yt(c),await this.nt(),await h(5*e),i=await r.Tt(),o?(a(i,"sendTabsToTheLeftMenus",!1),a(i,"sendTabsToTheRightMenus",!0)):(a(i,"sendTabsToTheLeftMenus",!0),a(i,"sendTabsToTheRightMenus",!1)),a(i,"sendAllTabsInAllWindowsMenus",!0),a(i,"sendTabsExceptThisMenus",!0),a(i,"sendAllTabsInCurrentWindowMenus",!0),a(i,"sendCurrentTabMenus",!1),this.assert(!i.displayOneTabMenu[x]),this.assert(!i.excludeWebSiteContextMenu[x]),await this.gt(t.st[1][0]),await h(e),i=await r.Tt(),a(i,"sendTabsToTheLeftMenus",!1),a(i,"sendTabsToTheRightMenus",!0),a(i,"sendAllTabsInAllWindowsMenus",!0),a(i,"sendTabsExceptThisMenus",!0),a(i,"sendAllTabsInCurrentWindowMenus",!0),a(i,"sendCurrentTabMenus",!0),this.assert(i.displayOneTabMenu[x]),this.assert(i.excludeWebSiteContextMenu[x]),this.assert(!i.excludeWebSiteContextMenu[O]),this.assert(i.excludeWebSiteContextMenu.title==="Exclude localhost from OneTab"),await this.gt(t.st[0][0]),await this.yt(t.st[0][0]),await r.X(),await this.yt(c),await this.gt(t.st[1][0]),await this.yt(t.st[1][0]),await this.Ct(t.st[1][1]),await this.Ct(t.st[1][2]),await h(e),i=await r.Tt(),a(i,"sendTabsToTheLeftMenus",!1),a(i,"sendTabsToTheRightMenus",!1),a(i,"sendAllTabsInAllWindowsMenus",!0),a(i,"sendTabsExceptThisMenus",!1),a(i,"sendAllTabsInCurrentWindowMenus",!1),a(i,"sendCurrentTabMenus",!1),this.assert(i.displayOneTabMenu[x]),this.assert(i.excludeWebSiteContextMenu[x]),this.assert(!i.excludeWebSiteContextMenu[O]),this.assert(i.excludeWebSiteContextMenu.title==="Exclude localhost from OneTab"),await this.Ct(t.st[1][0]),await h(e),i=await r.Tt(),a(i,"sendAllTabsInCurrentWindowMenus",!1),await Promise.all((await G()).filter(l=>l.url!==c&&l.url!==t.tt[0]).map(l=>C(l))),await this.gt(t.tt[0]),await h(e),i=await r.Tt(),a(i,"sendAllTabsInAllWindowsMenus",!1)}async ra(){console.log("begin testExcludeWebSiteContextMenu"),await this.dt(y),await r.re("127.0.0.1");let t={tt:[this.et("127.0.0.1"),this.et()],st:[[this.et(),this.et()],[this.et(),this.et("127.0.0.1"),this.et()]]};await this.ot(t,!0),await this.rt({tt:t.st[1],other:[t.tt,...t.st.slice(0,-1)]}),await h(1e3);let e=await r.Tt();this.assert(e.excludeWebSiteContextMenu[x]),this.assert(!e.excludeWebSiteContextMenu[O]),this.Gt(e.excludeWebSiteContextMenu.title,"Exclude localhost from OneTab"),await this.gt(t.st[1][1]),await h(1e3),e=await r.Tt(),this.assert(e.excludeWebSiteContextMenu[x]),this.assert(!e.excludeWebSiteContextMenu[O]),this.Gt(e.excludeWebSiteContextMenu.title,"Exclude 127.0.0.1 from OneTab"),await r.Ge("127.0.0.1");{let a=await r.getSettings(),i=r.Yt("127.0.0.1",a);this.assert(i)}await this.gt(t.tt[1]),await h(1e3),e=await r.Tt(),this.assert(e.excludeWebSiteContextMenu[x]),this.assert(!e.excludeWebSiteContextMenu[O]),this.Gt(e.excludeWebSiteContextMenu.title,"Exclude localhost from OneTab"),await this.gt(t.tt[0]),await h(1e3),e=await r.Tt(),this.assert(e.excludeWebSiteContextMenu[x]),this.assert(e.excludeWebSiteContextMenu[O]),this.Gt(e.excludeWebSiteContextMenu.title,"Exclude 127.0.0.1 from OneTab"),await r.re("127.0.0.1"),await Q(),await h(1e3),e=await r.Tt(),this.assert(e.excludeWebSiteContextMenu[x]),this.assert(!e.excludeWebSiteContextMenu[O]),this.Gt(e.excludeWebSiteContextMenu.title,"Exclude 127.0.0.1 from OneTab")}async oa(){console.log("begin testIgnoreOneTabContentPages");let t={tt:[this.et(),this.et()]};await this.ot(t,!0),await r.kt("import-export.html"),await r.kt("options.html"),await r.kt("import-export.html"),await r.kt("options.html");let e={st:[[this.et(),this.et()]]};await this.ot(e,!1),await r.kt("import-export.html"),await r.kt("options.html"),await this.Ct(e.st[0][0]),await this.Ct(e.st[0][1]),await this.rt({tt:[...t.tt,L+"import-export.html",L+"options.html"]}),await this.bt(),await this.rt({tt:[c]})}async la(){console.log("begin testExistingOneTabSwitchedTo");let t={tt:[this.et()],st:[[this.et(),this.et()],[this.et(),this.et(),this.et()]]};await this.ot(t,!0),await this.rt({tt:t.st[1],other:[t.tt,...t.st.slice(0,-1)]}),await r.X();let e=await r.St();await this.rt({tt:e?[c,...t.st[1]]:[...t.st[1],c],other:[t.tt,...t.st.slice(0,-1)]}),await this.gt(t.tt[0]),await this.yt(t.tt[0]),await r.X(!0),await this.yt(t.tt[0]),await r.X(),await this.yt(c),await this.rt({tt:e?[c,...t.st[1]]:[...t.st[1],c],other:[t.tt,...t.st.slice(0,-1)]})}async Va(){console.log("begin safariPinnedTabsTest"),await this.dt(y);let t={tt:[this.et(),this.et()],st:[[this.et(),this.et()]]};await this.ot(t,!0),await this.rt({tt:t.st[0],other:[t.tt]});let e=await k(!0),a=e.find(o=>o.focused),i=e.find(o=>!o.focused),n=200;await h(n),await r.X(),await this.nt(),await h(n),this.Gt((await k(!0)).find(o=>o.focused).id,a.id),await v(a.tabs[1]),await h(n),await r.X(),await h(n),this.Gt((await k(!0)).find(o=>o.focused).id,a.id),await v(i.tabs[1]),await h(n),await r.X(),await h(n),this.Gt((await k(!0)).find(o=>o.focused).id,i.id)}async Ta(){console.log("begin testPinnedTabsOption"),await this.dt(y);let t=await r.getSettings(),e=P("pinnedTabs",t);try{await r.ft("pinnedTabs","ignore");let a={tt:[this.Ht(),this.et()]};await this.ot(a,!0),await this.rt({tt:a.tt}),await this.bt(),await h(500);let i=await r.St();i?(await h(500),await this.rt({tt:[c,a.tt[0]]},!0)):await this.rt({tt:[a.tt[0],c]}),await this.Ct(a.tt[0]),await this.rt({tt:[c]}),await r.ft("pinnedTabs","allow"),await this.ot(a,!0),await this.rt({tt:a.tt}),await this.bt(),await h(100),await this.rt({tt:[c]}),await this.Ot(a.tt,0,!0),await r.it("clickTab",{url:a.tt[0],ut:{}}),await this.lt({tt:i?[c,a.tt[0]]:[a.tt[0],c]}),await this.Ea(a.tt[0])}finally{await r.ft("pinnedTabs",e)}}async pa(){console.log("begin testPinnedTabsOption2"),await this.dt(y);let t=await r.getSettings(),e=P("pinnedTabs",t);try{await r.ft("pinnedTabs","allow");let a={tt:[this.Ht(),this.Ht()]};await this.ot(a,!0),await this.rt({tt:a.tt}),await this.bt(),await this.rt({tt:[c]});let i={tt:[this.et()]};await this.ot(i,!1),await this.rt({tt:[c,...i.tt]}),await this.nt(),await r.it("clickTabGroupButton",{ht:"restoreAllButton",wt:a.tt[0],ut:{}}),await this.lt({tt:[...a.tt],other:[[c,...i.tt]]}),await this.bt(),await this.ct(0,[...a.tt]),await this.Ct(i.tt[0]),await this.rt({tt:[c]}),await this.nt(),await r.it("clickTabGroupButton",{ht:"restoreAllButton",wt:a.tt[0],ut:{}});let n=await r.St();await this.lt({tt:n?[c,...a.tt]:[...a.tt,c]})}finally{await r.ft("pinnedTabs",e)}}async ya(){console.log("begin testPinnedTabsOption3"),await this.dt(y);let t=await r.getSettings(),e=P("pinnedTabs",t);try{await r.ft("pinnedTabs","allow");let a={tt:[this.Ht()]};await this.ot(a,!0),await this.rt({tt:a.tt}),await this.bt(),await this.rt({tt:[c]});let i={tt:[this.et()]};await this.ot(i,!1),await this.rt({tt:[c,...i.tt]}),await this.nt(),await r.it("clickTabGroupButton",{ht:"restoreAllButton",wt:a.tt[0],ut:{}}),await this.lt({tt:[...a.tt],other:[[c,...i.tt]]}),await this.bt(),await this.ct(0,[...a.tt]),await this.Ct(i.tt[0]),await this.rt({tt:[c]}),await this.nt(),await r.it("clickTabGroupButton",{ht:"restoreAllButton",wt:a.tt[0],ut:{}});let n=await r.St();await this.lt({tt:n?[c,...a.tt]:[...a.tt,c]})}finally{await r.ft("pinnedTabs",e)}}async ma(){console.log("begin testRestoreRemovalOption"),await this.dt(y);let t=await r.getSettings(),e=P("restoreRemoval",t);try{await r.ft("restoreRemoval","default");let a={tt:[this.et(),this.et()]};await this.ot(a,!0),await this.bt(),await this.nt(),await h(200),await this.ct(0,[...a.tt]),await r.it("clickTabGroupButton",{ht:"restoreAllButton",wt:a.tt[0],ut:{}}),await this.lt({tt:[c,...a.tt]}),await this.Pt(a.tt[0]),await r.ft("restoreRemoval","keep"),await this.bt(),await this.nt(),await this.ct(0,[...a.tt]),await r.it("clickTabGroupButton",{ht:"restoreAllButton",wt:a.tt[0],ut:{}}),await this.lt({tt:[c,...a.tt]}),await this.ct(0,[...a.tt])}finally{await r.ft("restoreRemoval",e)}}async xa(){console.log("begin testDuplicatesOption"),await this.dt(y);let t=await r.getSettings(),e=P("restoreRemoval",t);try{await r.ft("restoreRemoval","default");let a={tt:[this.et(),this.et()]};await this.ot(a,!0),await this.bt(),await this.nt(),await h(200),await this.ct(0,[...a.tt]),await r.it("clickTabGroupButton",{ht:"restoreAllButton",wt:a.tt[0],ut:{}}),await this.lt({tt:[c,...a.tt]}),await this.Pt(a.tt[0]),await r.ft("restoreRemoval","keep"),await this.bt(),await this.nt(),await this.ct(0,[...a.tt]),await r.it("clickTabGroupButton",{ht:"restoreAllButton",wt:a.tt[0],ut:{}}),await this.lt({tt:[c,...a.tt]}),await this.ct(0,[...a.tt])}finally{await r.ft("restoreRemoval",e)}}async ga(){console.log("begin testRestoreWindowOption"),await this.dt(y);let t=await r.getSettings(),e=P("restoreWindow",t);try{await r.ft("restoreWindow","newWindow");let a={tt:[this.et(),this.et()]};await this.ot(a,!0),await this.bt(),await this.nt(),await this.lt({tt:[c]}),await this.ct(0,[...a.tt]),await r.it("clickTabGroupButton",{ht:"restoreAllButton",wt:a.tt[0],ut:{}}),await this.lt({tt:[c,...a.tt]}),await this.bt(),await this.lt({tt:[c]}),await this.ct(0,[...a.tt]);let i={tt:[this.et()]};await this.ot(i,!1),await r.X(),await r.it("clickTabGroupButton",{ht:"restoreAllButton",wt:a.tt[0],ut:{}}),await this.lt({tt:[...a.tt],other:[[c,...i.tt]]}),await r.ft("restoreWindow","newWindowAlways"),await this.bt(),await this.nt(),await this.Ct(i.tt[0]),await this.lt({tt:[c]}),await this.ct(0,[...a.tt]),await r.X(),await r.it("clickTabGroupButton",{ht:"restoreAllButton",wt:a.tt[0],ut:{}}),await this.lt({tt:[...a.tt],other:[[c]]}),await this.bt(),await this.nt(),await this.lt({tt:[c]}),await this.ct(0,[...a.tt]),await r.ft("restoreWindow","currentWindow"),await r.X(),await this.ot(i,!1),await r.it("clickTabGroupButton",{ht:"restoreAllButton",wt:a.tt[0],ut:{}}),await this.lt({tt:[c,i.tt[0],...a.tt]})}finally{await r.ft("restoreWindow",e)}}async Ma(){console.log("begin testLockUnlock"),await this.dt(y);let t={tt:[this.et(),this.et()]};await this.ot(t,!0),await this.bt(),await this.nt(),await this.lt({tt:[c]}),await this.ct(0,[...t.tt]),await h(150),this.assert(!(await r.it("getTabGroupElementDisplayed",{Jt:"lockImg",wt:t.tt[0]})).qt),this.assert(!(await this.ae(t.tt[0])).starred),await r.it("clickTabGroupButton",{ht:"moreButton",wt:t.tt[0],ut:{}}),await r.it("clickTabGroupButton",{ht:"toggleLockTabGroupButton",wt:t.tt[0],ke:"mousedown",ut:{}}),await h(150),this.assert((await this.ae(t.tt[0])).locked),await r.it("clickTabGroupButton",{ht:"restoreAllButton",wt:t.tt[0],ut:{}}),await h(200),await this.lt({tt:[c,...t.tt]}),await this.ct(0,[...t.tt]),await r.it("clickTabGroupButton",{ht:"deleteAllButton",wt:t.tt[0]}),await h(200),await this.ct(0,[...t.tt]),await r.it("clickTab",{url:t.tt[0],ut:{}}),await h(200),await this.ct(0,[...t.tt]),this.assert((await r.it("getTabGroupElementDisplayed",{Jt:"lockImg",wt:t.tt[0]})).qt)}async Sa(){console.log("begin testStarUnstar"),await this.dt(y);let t={tt:[this.et(),this.et()]};await this.ot(t,!0),await this.bt(),await this.nt(),await this.lt({tt:[c]}),await h(200),await this.ct(0,[...t.tt]);let e={tt:[this.et(),this.et()]};await this.ot(e,!0),await this.bt(),await this.nt(),await h(200),await this.lt({tt:[c]}),await this.ct(0,[...e.tt]);let a=await r.it("getVisibleStructure"),i=a.tabGroups.findIndex(u=>u.tabs.some(w=>w===t.tt[0])),n=a.tabGroups.findIndex(u=>u.tabs.some(w=>w===e.tt[0]));this.assert(i>0),this.assert(!(await r.it("getTabGroupElementDisplayed",{Jt:"starImg",wt:t.tt[0]})).qt),await r.it("clickTabGroupButton",{ht:"moreButton",wt:t.tt[0],ut:{}}),await h(300),await r.it("clickTabGroupButton",{ht:"toggleStarTabGroupButton",wt:t.tt[0],ke:"mousedown",ut:{}}),await h(1200),this.assert((await r.it("getTabGroupElementDisplayed",{Jt:"starImg",wt:t.tt[0]})).qt),a=await r.it("getVisibleStructure");let o=a.tabGroups.findIndex(u=>u.tabs.some(w=>w===t.tt[0]));this.assert(o===0),this.assert(o===await this.Fe(t.tt[0])),this.assert((await this.ae(t.tt[0])).starred),await r.it("clickTabGroupButton",{ht:"moreButton",wt:t.tt[0],ut:{}}),await r.it("clickTabGroupButton",{ht:"toggleStarTabGroupButton",wt:t.tt[0],ke:"mousedown",ut:{}}),await h(600),a=await r.it("getVisibleStructure");let l=a.tabGroups.findIndex(u=>u.tabs.some(w=>w===t.tt[0]));this.assert(i===l),this.assert(i===await this.Fe(t.tt[0])),this.assert(!(await this.ae(t.tt[0])).starred),this.assert(!(await r.it("getTabGroupElementDisplayed",{Jt:"starImg",wt:t.tt[0]})).qt)}async Ze(t){console.log("begin testFileUrls");let e;try{await this.dt(y);let a={tt:[t]};await this.ot(a,!0),await this.rt({tt:[t]}),await this.bt(),await this.nt(),await this.Ot([t],0,!0);let i=r.Dt(t);await r.it("clickTab",{url:i,ut:{}})}catch(a){e=String(a)}this.Gt(e,void 0)}async Ha(t){console.log("begin testPdfPlaceholders"),await this.dt(y);let e=r.Dt(t);this.assert(t!==e&&!e.startsWith("file://"),"pdfFilePlaceholderUrl not determined correctly");let a={tt:[t]};await this.ot(a,!0),await this.rt({tt:[t]}),await this.bt(),await h(200),await this.rt({tt:[c]}),await this.nt(),await this.Ot([t],0,!0),await r.it("clickTab",{url:e,ut:{}}),await this.lt({tt:[c,e]}),await this.bt(),await this.Ot([t],0,!0),await h(200),await r.it("clickTabGroupButton",{ht:"restoreAllButton",wt:e,ut:{}}),await h(200),await this.Pt(0,e),await this.Pt(0,t),await this.lt({tt:[c,e]})}async Ga(){await r.X(),await this.nt();let t=await r.it("testExtFavIconLoad");this.assert(t.success)}async Vt(){let t=(await G()).filter(a=>I(a.url));this.Pa(t.length,0,"cannot find any onetab tab");let e=t[0];return this.Gt(t.length,1,"there should only be exactly one onetab tab"),e}async _e(t){console.log("begin testPreserveLastOneTabTabPinnedState"),await r.X(),await this.nt();let e=await this.Vt(),a=e.pinned,i=500;a||(await z(e.id,{pinned:!0}),await h(i),await C(e),await h(i),await r.X(),await this.nt(),e=await this.Vt(),await h(i),this.assert(e.pinned)),a&&(await z(e.id,{pinned:!1}),await h(200),await C(e),await r.X(),await this.nt(),e=await this.Vt(),this.assert(!e.pinned),await z(e.id,{pinned:!0}),await h(200),await C(e),await h(200),await r.X(),await this.nt(),await h(200),e=await this.Vt(),this.assert(e.pinned)),await rt(t)}async Ot(t,e,a){let i=await r.getState();a&&(e+=i.tabGroups.findIndex(o=>!o.starred));let n=i.tabGroups.some((o,l)=>e!==void 0&&e!==l?!1:o.tabsMeta.every((u,w)=>{let d=t[w];if(d.includes(":3000/?title=")){let b=this.ce(d,"title")===u.title;return this.ce(d,"title").startsWith("PIN::")&&!u.pinned&&(b=!1),b||console.log(`assertStoredTabGroup mismatch: ${this.ce(d,"title")} vs ${u.title}`),b}else return d===u.url}));this.assert(n,`assertStoredTabGroup fail, expected: ${t} at index ${e}`)}async Wa(t){let e=await r.getState();this.assert(e.tabGroups.some(a=>a.tabsMeta.some(i=>i.url===t)))}async Aa(t){let e=await r.getState();this.assert(!e.tabGroups.some(a=>a.tabsMeta.some(i=>i.url===t)))}async Fe(t){return(await r.getState()).tabGroups.findIndex(e=>e.tabsMeta[0].url===t)}async ae(t){return(await r.getState()).tabGroups.find(e=>e.tabsMeta[0].url===t)}ce(t,e){t=t.substring(t.indexOf("?")+1);let a=t.split("&");for(let i in a){let n=a[i].split("=");if(n[0]===e)return decodeURIComponent(n[1])}}async dt(t){let a=(await G()).filter(n=>n.url&&!(n.title&&n.title.startsWith("t---")||n.title&&n.title.startsWith("PIN::t---")||n.title&&n.title.startsWith("localhost:"))&&![n.url,n.pendingUrl].some(o=>[L,wt,"file://"].some(l=>o&&o.startsWith(l))));if(a=a.filter(n=>!n.url.startsWith("http://localhost")),a.length>0)throw console.log(a),new Error(`Non-empty tabs found, aborting browser reset. ${a.map(n=>n.url).join(",")}`);let i=await k(!0);if(i.length===0)console.log("resetToSingleEmptyTabOpen: no open windows"),await Ft({url:t});else{i.slice(1).forEach(u=>kt(u.id));let n=i[0],{tabs:o,activeTab:l}=await se(n.id);await B({windowId:n.id,url:t}),await Promise.all(o.map(u=>C(u)))}await this.ie()}async ie(){await Ct(1e4,"waitForAllTabsLoaded",async()=>!(await G()).some(t=>t.status==="loading"))}async ot(t,e){let a={tt:[],st:[]},i=[];if(e&&(i=await G()),t.tt)for(let n=0;n<t.tt.length;n++)a.tt.push(await this.openTab(t.tt[n]));if(t.st)for(let n=0;n<t.st.length;n++){let{zt:o,Qt:l}=await this.ka(t.st[n]);a.st.push(l)}return await Promise.all(i.map(n=>C(n))),await this.ie(),a}async lt(t){await this.ie(),await Ct(1e4,"waitForAndAssertTabStructure",async e=>{try{return await this.rt(t),!0}catch(a){return e>3e3&&console.log(a),!1}})}async Ea(t){let e=await at();this.assert(e.some(a=>a.some(i=>[i.url,i.pendingUrl].some(n=>n===t)&&i.pinned)))}async rt(t,e){if(!t.tt&&!t.other)throw new Error("invalid tabStruct");await this.ie();let a=await at(!0);if(!await J())throw new Error("No lastFocusedWindow found");let n=(await J()).tabs;if(t.tt){let o=n.map(u=>[u.url,u.pendingUrl].find(w=>w)).join(" , "),l=t.tt.join(" , ");if(o!==l){let u=`No match for tabs in last focused window (actual, expected): 
${o}

${l}`;throw new Error(u)}}if(t.other){let o=a.map(u=>u.map(w=>[w.url,w.pendingUrl].find(d=>d)).join(" , ")).sort().join(`
`),l=t.other.map(u=>u.join(" , ")).sort().join(`
`);if(o!==l){let u=`No match for tabs in non focused windows (actual, expected):
${o}

${l}`;throw new Error(u)}}}async Ia(t){for(let e of ft(5e3))try{await this.yt(t);return}catch{await h(e)}throw new Error("waitForAndAssertActiveTab failed after time-out")}async nt(){for(let t of ft(1e4)){try{if((await G()).some(e=>I(e.url)))try{await r.it("ping");return}catch{}}catch(e){console.log(e)}t>200&&console.log(`waitForOneTabTabExistsAndRespondsToRpc pause for: ${t}`),await h(t)}throw new Error("waitForOneTabTabExistsAndRespondsToRpc failed after time-out")}async yt(t){let e=(await Pt()).url;if(e!==t)throw new Error(`active tab not as expected (actual, expected): "${e}", "${t}"`)}async openTab(t){return await r.Ke(t,t.includes("?title="+encodeURIComponent("PIN::")))}async ka(t){let{zt:e,Qt:a}=await yt(t.map(i=>({url:i,pinned:i.includes("?title="+encodeURIComponent("PIN::"))})));return{zt:e,Qt:a}}async bt(){await r.At(void 0)}async gt(t){await v((await G()).find(e=>e.url===t))}async Ct(t){let e=(await G()).find(a=>a.url===t);if(!e)throw new Error("Could not find tab with URL: "+t);await C(e)}De(t,e){return e||(e="localhost"),`http://${e}:3000/?title=${encodeURIComponent(t)}`}et(t){return this.De(this.uuid(),t)}Ht(t){return this.De("PIN::"+this.uuid(),t)}uuid(){return"t---"+_(6,16).toLowerCase()}assert(t,e){if(!t)throw new Error("Assertion failed"+(e?" "+e:""))}Gt(t,e,a){if(t!==e)throw new Error(`Assertion failed, ${t} !== ${e}, ${a}`)}Pa(t,e,a){if(!(t>e))throw new Error(`Assertion failed, ! (${t} > ${e}), ${a}`)}}let r=new U;xe();async function vt(){let t=(await G()).find(a=>I(a.url)),e=t?{index:t.index,windowId:t.windowId,pinned:t.pinned,active:t.active,updateDate:new Date().getTime(),updateEvent:"onUpdateAvailable"}:{};await r.ue(e),await de()}function xe(){Me(),chrome.runtime.onUpdateAvailable&&chrome.runtime.onUpdateAvailable.addListener(async()=>{await vt()}),chrome.runtime.onInstalled.addListener(async a=>{await s()}),chrome.runtime.onStartup.addListener(async()=>{await s()});async function s(){try{await r.qe(),await E().clearAll(),await ye(),await ge(),await X()}catch(a){console.log("onStartup exception"),console.log(a)}}async function t(a){await Gt(),await r.At(void 0,a)}chrome.action.onClicked.addListener(async a=>t(a));const e={displayOneTabMenu:async(a,i,n)=>await r.He(i?.windowId),sendAllTabsInCurrentWindowMenus:async(a,i,n)=>await r.At(n[[R]],i),sendThisWebLinkMenus:async(a,i,n)=>await r.Ve(a,i,n[[R]]),sendCurrentTabMenus:async(a,i,n)=>await r.oe(n[[R]],i),sendTabsExceptThisMenus:async(a,i,n)=>await r.Ie(n[[R]],i),sendTabsToTheLeftMenus:async(a,i,n)=>await r.We(n[[R]],i),sendTabsToTheRightMenus:async(a,i,n)=>await r.Ae(n[[R]],i),sendAllTabsInAllWindowsMenus:async(a,i,n)=>await r.Kt(n[[R]]),helpMenu:async(a,i,n)=>await it(St+"/help",!1,!0),excludeWebSiteContextMenu:async(a,i,n)=>{let o=await r.getSettings(),l=$(A((await J()).activeTab.url));r.Yt(l,o)?await r.re(l):await r.Ge(l),await Q()}};chrome.contextMenus.onClicked.addListener(async(a,i)=>{await Gt();let n=a.menuItemId,o=await r.Tt(),l=Object.entries(o).find(([u,w])=>{let d=Array.isArray(w)?w.find(b=>b.id===n):w;return d&&d.id===n});if(l){let[u,w]=l,d=Array.isArray(w)?w.find(f=>f.id===n):w,b=Object.entries(e).find(([f,m])=>f===u);if(b){let[,f]=b;await f(a,i,d)}else console.log(`no actionMenuItemType matched for menuItemType: ${u}`)}else console.log(`contextMenuState item not found for menuItemId ${n}`)}),le(),ue(()=>Q()),we()}async function ge(){let s=await S().get("lastSeenVersion");if(String(ut)!==String(s)){await S().put("lastSeenVersion",ut);let t=await r.Oe();(await k(!1)).some(e=>!e.incognito)&&t.windowId&&new Date().getTime()-(t.updateDate||0)<1e3*30&&(await Promise.all((await G()).filter(i=>I(i.url)).map(i=>C(i))),(await k(!1)).find(i=>!i.incognito&&i.id===t.windowId)&&await r.ze({windowId:t.windowId,index:t.index,url:c,active:!!t.active,pinned:!!t.pinned})),await r.ue({})}else{let t=await r.getSettings();(await r.getState()).tabGroups.map(i=>i.tabsMeta.length).reduce((i,n)=>i+n,0)>0&&P("startupLaunch",t)==="displayOneTab"&&((await k(!1)).find(i=>!i.incognito)?await r.X(!0):chrome.windows.onCreated.addListener(async i=>{try{await r.fe.It(),await E().get("openOneTabOnStartTriggered")||(await k(!1)).find(n=>!n.incognito)&&(await E().put("openOneTabOnStartTriggered","true"),await r.X(!0))}finally{r.fe.release()}}))}}function Me(){chrome.runtime.onMessage.addListener((s,t,e)=>{if(t.id===chrome.runtime.id&&s.L)return r[s.type]?r[s.type].constructor.name==="AsyncFunction"?(s.args&&(s.args=Tt(s.args,Zt,void 0)),r[s.type](...s.args).then(a=>{e({result:a})}).catch(a=>{a.stack&&console.log(a.stack),e({S:a})}),!0):(e(r[s.type](...s.args)),!1):(e({S:"No such core method found"}),!1)})}async function qe(){return;try{if(!await Se())return;await Promise.all((await G()).filter(s=>s.pinned&&!s.pendingUrl&&!s.url).map(async s=>{await C(s)}))}catch(s){console.log("cleanupSafariTabs exception"),console.log(s)}}async function Se(){return((await chrome.permissions.getAll())?.origins??[]).includes("*://*/*")}globalThis.populateWithTestData=async()=>{await r.Ne(),console.log("populateWithTestData done")},globalThis.testRestoreOnVersionUpdate=async()=>{await r.Qe()},globalThis.runTestSuite=async s=>{await r.Ye(s)},globalThis.loopTestSuite=async(s,t)=>{await r.Xe(s,t)};
